services:
  mongo:
    image: mongo:8.0
    container_name: mongo
    ports:
      - 27017:27017
    command: >
      bash -c "
        mongod --replSet rs0 --bind_ip_all &
        pid=$$!;

        until mongosh --quiet --eval 'db.runCommand({ ping:1 })' >/dev/null 2>&1; do
          sleep 1;
        done;

        mongosh --quiet --eval '
          try {
            rs.status();
          } catch (e) {
            rs.initiate({_id: \"rs0\", members: [{_id: 0, host: \"mongo:27017\"}]});
          }
        ';
        wait $$pid;
      "
    volumes:
      - ./mongo_data/data:/data/db

  stripe-listen:
    build: ../stripe
    container_name: stripe-listen
    restart: unless-stopped
    env_file:
      - ../admin-service/.env.production
    volumes:
      - ../stripe/shared/.env.stripe:/shared/.env.stripe

  admin-service:
    build: ../admin-service
    container_name: admin-service
    expose:
      - 3001
    restart: unless-stopped
    depends_on:
      - mongo
      - stripe-listen
    volumes:
      - ../admin-service/.env.production:/app/.env
      - ../stripe/shared/.env.stripe:/app/.env.stripe


  enterprise-service:
    build: ../enterprise-service
    container_name: enterprise-service
    expose:
      - 3002 # gw
      - 3010 # auth
      - 3011 # merch
    restart: unless-stopped
    depends_on:
      - mongo
    volumes:
      - ../enterprise-service/.env.production:/app/.env


  users-service:
    build: ../users-service
    container_name: users-service
    expose:
      - 3000
    restart: unless-stopped
    depends_on:
      - mongo
    volumes:
      - ../users-service/.env.production:/app/.env


  frontend:
    build: ../../frontend
    container_name: frontend
    expose:
      - 80
    restart: unless-stopped


  nginx:
    image: fholzer/nginx-brotli:latest
    container_name: nginx_rev_proxy
    ports:
      - 80:80
    restart: unless-stopped
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - frontend
      - users-service
      - admin-service
      - enterprise-service